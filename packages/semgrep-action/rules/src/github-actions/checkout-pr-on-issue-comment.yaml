rules:
- id: checkout-pr-on-issue-comment
  languages:
    - yaml
  message: >-
    A workflow triggered by an `issue_comment` event is checking out a pull request. This could allow an attacker to inject malicious code by commenting on an issue in a way that causes unintended execution. Ensure proper validation is in place before checking out PRs.
  severity: ERROR
  patterns:
    - pattern-either:
      - pattern-inside: |
          on:
            ...
            issue_comment: ...
            ...
          ...
      - pattern-inside: |
          on: [..., issue_comment, ...]
          ...
      - pattern-inside: |
          on: issue_comment
          ...
    - pattern-inside: |
        jobs:
          ...
          $JOBNAME:
            ...
            steps:
              ...
    - pattern: |
        run: $CMD
    - metavariable-regex:
        metavariable: $CMD
        regex: ".*gh pr checkout.*"
  metadata:
    category: security
    cwe:
      - "CWE-94: Improper Control of Generation of Code ('Code Injection')"
    owasp:
      - A08:2021 - Software and Data Integrity Failures
    references:
      - https://docs.github.com/en/actions/learn-github-actions/security-hardening-for-github-actions#understanding-the-risk-of-script-injections
    technology:
      - github-actions
      - actions/checkout
    cwe2022-top25: true
    cwe2021-top25: true
    subcategory:
      - audit
    likelihood: MEDIUM
    impact: HIGH
    confidence: MEDIUM

- id: publish-actions-cache-used
  languages:
    - yaml
  severity: WARNING
  metadata:
    category: security
    cwe:
      - "CWE-494: Download of Code Without Integrity Check"
    owasp:
      - A08:2021 - Software and Data Integrity Failures
    references:
      - https://github.com/MetaMask/MetaMask-planning/issues/3925
    technology:
      - github-actions
      - actions/cache
    cwe2022-top25: true
    cwe2021-top25: true
    subcategory:
      - audit
    likelihood: MEDIUM
    impact: HIGH
    confidence: MEDIUM
    tags: [security]
    shortDescription: Potential cache poisoning risk by using `actions/cache` in a publishing workflow.
    help: |
      ## Remediation
      We recommend avoiding using `actions/cache` if this workflow publishes a release or has access to sensitive secrets. 
      If caching is required, please see https://github.com/MetaMask/MetaMask-planning/issues/3925 for a workaround.
  message: >-
      Using GitHub's Action Cache in publishing workflows, especially in open source repositories, can be dangerous. See
      https://github.com/MetaMask/MetaMask-planning/issues/3925 for more details and alternative recommendations.
  patterns:
      - pattern: "uses: $ACTION_NAME"
      - metavariable-regex:
          metavariable: $ACTION_NAME
          regex: actions/cache@.+
  paths:
    include:
      - ".github/**/*publish*.yml"