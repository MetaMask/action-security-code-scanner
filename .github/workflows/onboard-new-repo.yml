name: 'Onboard New Repository with SAST'

on:
  workflow_dispatch:
    inputs:
      organization:
        description: 'Organization name (e.g., MetaMask)'
        required: true
        type: string
      repository:
        description: 'Repository name (e.g., snaps)'
        required: true
        type: string
  repository_dispatch:
    types: [new_repository_created]

jobs:
  create-sast-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout scanner action repository
        uses: actions/checkout@v4
        with:
          path: scanner-repo

      - name: Determine target repository
        id: target
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            ORG="${{ github.event.client_payload.organization }}"
            REPO_NAME="${{ github.event.client_payload.repository }}"
            REPO="$ORG/$REPO_NAME"
          else
            REPO="${{ inputs.organization }}/${{ inputs.repository }}"
          fi

          # Auto-detect default branch from the repository
          echo "Detecting default branch for $REPO..."
          BASE_BRANCH=$(gh api "repos/$REPO" --jq '.default_branch' 2>/dev/null || echo "")

          # If repo is empty or API call failed, default to 'main'
          if [ -z "$BASE_BRANCH" ] || [ "$BASE_BRANCH" = "null" ]; then
            echo "Repository is empty or default branch not found. Defaulting to 'main'"
            BASE_BRANCH="main"
          fi

          echo "repository=$REPO" >> "$GITHUB_OUTPUT"
          echo "base_branch=$BASE_BRANCH" >> "$GITHUB_OUTPUT"
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.ONBOARDING_TOKEN }}

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.target.outputs.repository }}
          token: ${{ secrets.ONBOARDING_TOKEN }}
          path: target-repo
          ref: ${{ steps.target.outputs.base_branch }}

      - name: Create branch and add SAST workflow
        working-directory: target-repo
        run: |
          git config user.name "MetaMask Security Bot"
          git config user.email "security-bot@metamask.io"

          BRANCH_NAME="security/add-sast-scanner"
          git checkout -b "$BRANCH_NAME"

          # Create .github/workflows directory if it doesn't exist
          mkdir -p .github/workflows

          # Copy the security scanner workflow template and replace placeholders
          BASE_BRANCH="${{ steps.target.outputs.base_branch }}"
          sed "s/{ DEFAULT_BRANCH }/$BASE_BRANCH/g" \
            ../scanner-repo/.github/templates/security-code-scanner.yml \
            > .github/workflows/security-code-scanner.yml

          git add .github/workflows/security-code-scanner.yml
          git commit -m "chore: add MetaMask Security Code Scanner workflow

          This PR adds the MetaMask Security Code Scanner workflow to enable
          automated security scanning of the codebase.

          The scanner will run on:
          - Push to main branch
          - Pull requests to main branch
          - Manual workflow dispatch

          To configure the scanner for your repository's specific needs,
          please review the workflow file and adjust as necessary."

          git push origin "$BRANCH_NAME"
        shell: bash

      - name: Create Pull Request
        working-directory: target-repo
        env:
          GH_TOKEN: ${{ secrets.ONBOARDING_TOKEN }}
          REPO_NAME: ${{ steps.target.outputs.repository }}
        run: |
          # Extract owner and repo name for URL construction
          OWNER=$(echo "$REPO_NAME" | cut -d'/' -f1)
          REPO=$(echo "$REPO_NAME" | cut -d'/' -f2)
          BASE_BRANCH="${{ steps.target.outputs.base_branch }}"
          SECURITY_URL="https://github.com/${OWNER}/${REPO}/security/code-scanning"

          # Read PR body template and substitute variables
          PR_BODY=$(cat ../scanner-repo/.github/templates/onboarding-pr-body-automated.md)
          PR_BODY="${PR_BODY//\{\{SECURITY_SCANNING_URL\}\}/$SECURITY_URL}"

          gh pr create \
            --title "ðŸ”’ Add MetaMask Security Code Scanner" \
            --body "$PR_BODY" \
            --base "$BASE_BRANCH" \
            --head "security/add-sast-scanner"
        shell: bash

      - name: Output PR URL
        working-directory: target-repo
        env:
          GH_TOKEN: ${{ secrets.ONBOARDING_TOKEN }}
        run: |
          PR_URL=$(gh pr view security/add-sast-scanner --json url -q .url)
          echo "âœ… Pull Request created: $PR_URL"
          echo "PR_URL=$PR_URL" >> "$GITHUB_OUTPUT"
        shell: bash
